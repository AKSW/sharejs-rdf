var WEB=!0,RdfJsonDoc,RdfJsonOperation,SparkMD5,WEB,cloneExportTriples,cloneTriples,exportTriplesDifference,exportTriplesIntersect,hashTripleObject,md5,rdfJson,sharejs;"object"==typeof window&&window.document&&(WEB=!0),md5=function(a){return SparkMD5.hash(a)},hashTripleObject=function(a){var b;return(b=function(a,b){var c,d,e,f;for(d="",e=0,f=b.length;f>e;e++)c=b[e],"undefined"!=typeof a[c]&&(d+=""+c+":'"+a[c]+"';");return md5(d)})(a,["type","value","lang","datatype"])},cloneTriples=function(a){var b,c,d,e,f,g,h,i,j,k;k={};for(j in a){i=a[j],k[j]={};for(h in i){g=i[h],k[j][h]={};for(f in g){d=g[f],e={};for(b in d)c=d[b],e[b]=c;k[j][h][f]=e}}}return k},cloneExportTriples=function(a){var b,c,d,e,f,g,h,i,j,k,l;j={};for(i in a){h=a[i],j[i]={};for(g in h)for(f=h[g],j[i][g]=[],k=0,l=f.length;l>k;k++){d=f[k],e={};for(b in d)c=d[b],e[b]=c;j[i][g].push(e)}}return j},exportTriplesIntersect=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;c={},l=0;for(k in a)if(j=a[k],b[k])for(i in j)if(f=j[i],b[k][i]){for(g=b[k][i],h=[],m=0,o=f.length;o>m;m++)for(d=f[m],n=0,p=g.length;p>n;n++)e=g[n],d.type===e.type&&d.value===e.value&&d.lang===e.lang&&d.datatype===e.datatype&&(h.push(d),l++);h.length>0&&(c[k]||(c[k]={}),c[k][i]=h)}return[c,l]},exportTriplesDifference=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;k={};for(j in a){i=a[j];for(h in i){if(e=i[h],g=[],b[j]&&b[j][h])for(f=b[j][h],l=0,n=e.length;n>l;l++)for(c=e[l],m=0,o=f.length;o>m;m++)d=f[m],(c.type!==d.type||c.value!==d.value||c.lang!==d.lang||c.datatype!==d.datatype)&&g.push(c);else g=e;g.length>0&&(k[j]||(k[j]={}),k[j][h]=g)}}return k},RdfJsonDoc=function(){function a(a){null==a&&(a={}),this._uriRegex=/^\w+:\/\/\w+(\.\w+)+\//,this._triples={},this.insert(a)}return a.prototype.exportTriples=function(){var a,b,c,d,e,f,g,h,i,j,k;h={},k=this._triples;for(g in k){f=k[g],h[g]={};for(e in f){d=f[e],h[g][e]=[],c=[];for(b in d)a=d[b],c.push(b);for(c.sort(),i=0,j=c.length;j>i;i++)b=c[i],a=d[b],h[g][e].push(a)}}return h},a.prototype.clone=function(){var b;return b=new a,b._triples=cloneTriples(this._triples),b},a.prototype.insert=function(a){var b,c,d,e,f,g,h;h=[];for(g in a)f=a[g],this.assertSubjectIsUri(g),this._triples[g]||(this._triples[g]={}),h.push(function(){var a;a=[];for(e in f)d=f[e],this.assertPredicateIsUri(e,g),this.assertObjectsArray(d,g,e),this._triples[g][e]||(this._triples[g][e]={}),a.push(function(){var a,f,h;for(h=[],a=0,f=d.length;f>a;a++)b=d[a],c=hashTripleObject(b),h.push(this._triples[g][e][c]=b);return h}.call(this));return a}.call(this));return h},a.prototype["delete"]=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;o=[];for(l in a)if(h=a[l],this.assertSubjectIsUri(l),this._triples[l]){f=0;for(g in h)if(e=h[g],this.assertPredicateIsUri(g,l),this.assertObjectsArray(e,l,g),f++,this._triples[l][g]){for(k=this._triples[l][g],m=0,n=e.length;n>m;m++)c=e[m],d=hashTripleObject(c),k[d]&&delete this._triples[l][g][d];b=0;for(j in k)i=k[j],b++;0===b&&(f--,delete this._triples[l][g])}o.push(0===f?delete this._triples[l]:void 0)}return o},a.prototype.assertSubjectIsUri=function(a){if("string"!=typeof a||!this.isUri(a))throw new Error("Subject must be an URI: "+a)},a.prototype.assertPredicateIsUri=function(a,b){if("string"!=typeof a||!this.isUri(a))throw new Error("Predicate must be an URI: "+a+" (of subject "+b+")")},a.prototype.assertObjectsArray=function(a,b,c){if("object"!=typeof a||!(a instanceof Array))throw new Error("Objects must be an array of objects: "+a+" (of subject "+b+", predicate "+c+")")},a.prototype.isUri=function(a){return a.match(this._uriRegex)},a}(),RdfJsonOperation=function(){function a(a,b){this._operation=a,this._triples=b}return a.prototype.OP_INSERT="insert",a.prototype.OP_DELETE="delete",a.insert=function(b){return new a(a.prototype.OP_INSERT,b)},a["delete"]=function(b){return new a(a.prototype.OP_DELETE,b)},a.prototype.clone=function(){return new a(this.operation(),cloneExportTriples(this.getTriples()))},a.prototype.operation=function(){return this._operation},a.prototype.getTriples=function(){return this._triples},a.prototype.setTriples=function(a){return this._triples=a},a}(),rdfJson={Doc:RdfJsonDoc,Operation:RdfJsonOperation,name:"rdf-json",create:function(){return new RdfJsonDoc},apply:function(a,b){var c;if(!(a instanceof RdfJsonDoc))throw new Error("Snapshot must be a RdfJsonDoc instance. Given: "+a);if(!(b instanceof RdfJsonOperation))throw new Error("Operation must be a RdfJsonOperation instance. Given: "+b);switch(c=a.clone(),b.operation()){case RdfJsonOperation.prototype.OP_INSERT:c.insert(b.getTriples());break;case RdfJsonOperation.prototype.OP_DELETE:c["delete"](b.getTriples())}return c},transform:function(a,b,c){var d,e,f,g,h,i;if(e=a.clone(),d="right"===c,"left"!==c&&"right"!==c)throw new Error("Bad parameter 'side' given: "+c);return d?e:a.operation()===b.operation()?e:(i=exportTriplesIntersect(a.getTriples(),b.getTriples()),g=i[0],h=i[1],0===h?e:(f=exportTriplesDifference(a.getTriples(),b.getTriples()),e.setTriples(f),e))}},null!=WEB?(sharejs=window.sharejs,sharejs.types||(sharejs.types={}),sharejs.types["rdf-json"]=rdfJson):(SparkMD5=require("spark-md5"),module.exports=rdfJson);var rdfJson;"undefined"==typeof WEB&&(rdfJson=require("./rdf-json")),rdfJson.api={provides:{rdfJson:!0},_register:function(){return this.on("remoteop",function(a){switch(a._operation){case"insert":return this.emit("insert",a._triples);case"delete":return this.emit("delete",a._triples)}})}};